{% extends 'base.html' %}
{% block css %}
    <style>
    :root {
        --kanban-column-width: 350px;
        --task-border-radius: 1rem;
    }

    .department-list-buttons {
        position: sticky;
        background: var(--bg-light);
        padding: 10px 0;
        z-index: 10;
        border-bottom: 1px solid var(--border-color);
    }

    .list {
        display: flex;
        overflow-x: auto;
        gap: 1rem;
        padding: 0.5rem 0;
    }

    .links-dep {
        color: var(--text-secondary);
        text-decoration: none;
        padding: 0.75rem 1.25rem;
        border-radius: var(--task-border-radius);
        transition: all 0.3s ease;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        white-space: nowrap;
        cursor: pointer;
    }

    .links-dep:hover {
        color: var(--primary-color);
        background-color: var(--primary-light);
        transform: translateY(-1px);
    }

    .links-dep.active {
        color: var(--primary-color);
        background-color: var(--primary-light);
        font-weight: 600;
    }

    .task-list-container {
        display: flex;
        gap: 1.5rem;
        padding: 1.5rem 0;
        overflow-x: auto;
        height: calc(100vh - 180px);
    }

    .task-list {
        width: var(--kanban-column-width);
        flex-shrink: 0;
    }

    .task-list-head {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        padding: 0.5rem;
        border-radius: 0.5rem;
    }

    .task-list-dragdrop {
        min-height: 200px;
        padding: 0.5rem;
        background-color: var(--bg-secondary);
        border-radius: var(--task-border-radius);
    }

    .task-list-dragdrop.drag-over {
        background-color: var(--primary-light);
        outline: 2px dashed var(--primary-color);
    }

    .task {
        background: var(--bg-light);
        border-radius: var(--task-border-radius);
        padding: 1.25rem;
        margin-bottom: 1rem;
        box-shadow: var(--shadow-sm);
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .task:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .task.dragging {
        opacity: 0.5;
        cursor: pointer;
    }



    .task-title {
        color: var(--text-primary);
        font-weight: 600;
        font-size: 1rem;
        line-height: 1.5;
    }

    .task-description {
        color: var(--text-secondary);
        font-size: 0.9rem;
        line-height: 1.6;
        margin: 1rem 0;
    }

    .progress {
        height: 0.25rem !important;
        background-color: var(--bg-secondary);
        border-radius: 0.125rem;
        margin: 0.5rem 0;
    }

    .progress-bar {
        background-color: var(--primary-color);
        border-radius: 0.125rem;
    }

    .task-footer {
        border-top: 1px solid var(--border-color);
        padding-top: 1rem;
        margin-top: 1rem;
    }

    .task-platform-id {
        color: var(--text-secondary);
        font-size: 0.85rem;
        font-weight: 500;
    }

    .task-data {
        color: var(--text-secondary);
        font-size: 0.85rem;
    }

    .task-data ion-icon {
        font-size: 1.1rem;
    }

    .btn-icon {
        padding: 0.5rem;
        border-radius: 0.5rem;
        color: var(--text-secondary);
        transition: all 0.2s ease;
    }

    .btn-icon:hover {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
    }
    .task-link{
        text-decoration:none;
        color: #6b7280;
    }
    .badge {
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.85rem;
        font-weight: 500;
    }
    .nav-bar{
        margin-bottom: 0 !important;
    }
    @media (max-width: 768px) {
        .task-list-container {
            height: calc(100vh - 220px);
        }

        .links-dep {
            padding: 0.5rem 1rem;
        }
    }
    </style>
{% endblock %}

{% block js %}
<script>
$(document).ready(function() {
    let draggingTask = null;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –∑–∞–¥–∞—á
    function updateTaskCounters() {
        $('.task-list').each(function() {
            const taskCount = $(this).find('.task').length;
            $(this).find('.count').text(taskCount);
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏
    function getColumnName(column) {
        return column.closest('.task-list').find('.task-list-dragdrop').attr('id');
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
    function getTaskInfo(task) {
        const taskId = $(task).find('.task-platform-id').data('id');
        const taskTitle = $(task).find('.task-title').text().trim();
        return {
            id: taskId,
            title: taskTitle
        };
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–¥–∞—á–∏
    function createTaskCard(task) {
        return `
            <div class="task" draggable="true">
                <div class="task-header">
                    <div class="d-flex justify-content-between align-items-start gap-3">
                        <div class="task-title"><a href="/task/${task.platform_id}" class="task-link">${task.title}</a></div>

                    </div>
                </div>

            </div>`;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    updateTaskCounters();

    // Drag Start
    $(document).on('dragstart', '.task', function(e) {
        draggingTask = this;
        $(this).addClass('dragging');
        e.originalEvent.dataTransfer.setData('text/plain', '');

        const taskInfo = getTaskInfo(this);
        const sourceColumn = getColumnName($(this));
        console.log('üéØ –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:', {
            taskId: taskInfo.id,
            taskTitle: taskInfo.title,
            from: sourceColumn
        });
    });

    // Drag End
    $(document).on('dragend', '.task', function() {
        $(this).removeClass('dragging');
        $('.task-list-dragdrop').removeClass('drag-over');
        draggingTask = null;
        updateTaskCounters();
    });

    // Drag Over
    $('.task-list-dragdrop').on('dragover', function(e) {
        e.preventDefault();
        $(this).addClass('drag-over');
    });

    // Drag Leave
    $('.task-list-dragdrop').on('dragleave', function(e) {
        e.preventDefault();
        $(this).removeClass('drag-over');
    });

    // Drop
    $('.task-list-dragdrop').on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('drag-over');

        if (draggingTask) {
            const taskInfo = getTaskInfo(draggingTask);
            const sourceColumn = getColumnName($(draggingTask));
            const targetColumn = getColumnName($(this));

            $(this).append(draggingTask);

            console.log('‚úÖ –ó–∞–¥–∞—á–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞:', {
                taskId: taskInfo.id,
                taskTitle: taskInfo.title,
                from: sourceColumn,
                to: targetColumn,
                timestamp: new Date().toLocaleTimeString()
            });
        }
    });

    // Department Switching
    $('.links-dep').click(function() {
        $('.links-dep').removeClass('active');
        $(this).addClass('active');
        fetchTasks($(this).data('dep'))
        console.log('üëâ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –æ—Ç–¥–µ–ª:', $(this).text().trim());
    });

    // Task Menu Actions
    $('.dropdown-item').click(function(e) {
        e.preventDefault();
        const action = $(this).text().trim();
        const taskEl = $(this).closest('.task');
        const taskInfo = getTaskInfo(taskEl);

        if (action === '–£–¥–∞–ª–∏—Ç—å') {
            console.log('üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏:', {
                taskId: taskInfo.id,
                taskTitle: taskInfo.title
            });
            taskEl.fadeOut(300, function() {
                $(this).remove();
                updateTaskCounters();
            });
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
    $('#saveTaskBtn').click(function() {
        const taskData = {
            title: $('#taskTitle').val(),
            description: $('#taskDescription').val(),
            priority: $('#taskPriority').val(),
            deadline: $('#taskDeadline').val(),
            platform_id: $('#taskPlatformId').val(),
            status: 'new'
        };

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
        if (!taskData.title || !taskData.deadline || !taskData.platform_id) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
            return;
        }

        // AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
        $.ajax({
            url: '/api/tasks/create',
            method: 'POST',
            data: taskData,
            success: function(response) {
                // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
                const newTaskHtml = createTaskCard(taskData);

                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ –∫–æ–ª–æ–Ω–∫—É "–ù–∞–¥–æ —Å–¥–µ–ª–∞—Ç—å"
                $('#new').append(newTaskHtml);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                updateTaskCounters();

                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                $('#addTaskModal').modal('hide');

                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                $('#addTaskForm')[0].reset();
            },
            error: function(err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏:', err);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
            }
        });
    });

    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    $('#addTaskModal').on('hidden.bs.modal', function() {
        $('#addTaskForm')[0].reset();
    });

    function fetchTasks(departmentId) {
        $.ajax({
            url: `http://127.0.0.1:8000/api/tasks/department/${departmentId}`,
            method: 'POST',
            success: function (data) {
                // –û—á–∏—Å—Ç–∫–∞ –∫–æ–ª–æ–Ω–æ–∫
                $('#new').empty();
                $('#inprocess').empty();
                $('#testing').empty();
                $('#done').empty();

                // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∑–∞–¥–∞—á –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
                const groupedTasks = {
                    new: [],
                    inprocess: [],
                    testing: [],
                    done: []
                };

                data.forEach(task => {
                    if (groupedTasks[task.status]) {
                        groupedTasks[task.status].push(task);
                    }
                });

                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫
                Object.keys(groupedTasks).forEach(status => {
                    groupedTasks[status].forEach(task => {
                        $(`#${status}`).append(createTaskCard(task));
                    });
                });

                updateTaskCounters();
            },
            error: function (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞—á:', err);
            }
        });
    }

    {% if user.role_id == 4 or user.role_id == 3 %}
    fetchTasks({{ user.department }})
    {% else %}
    fetchTasks(1)
    {% endif %}
});
</script>
{% endblock %}

{% block content %}
    {% if user.role_id == 1 or user.role_id == 2 %}
    <div class="department-list-buttons">
        <div class="container">
            <div class="list">
            {% for item in department %}
                    {% if user.role_id == 1 or user.role_id == 2 %}
                        <div title="{{ item.description }}" data-dep="{{ item.id }}" class="links-dep {% if loop.index == 1 %}active{% endif %}">
                            <ion-icon name="folder-outline"></ion-icon>
                            {{ item.name }}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="container">
        <div class="task-list-container">
            <!-- –ö–æ–ª–æ–Ω–∫–∞ "–ù–∞–¥–æ —Å–¥–µ–ª–∞—Ç—å" -->
            <div class="task-list">
                <h5 class="task-list-head">
                    <ion-icon name="list-outline" style="color: var(--warning-color)"></ion-icon>
                    –ù–∞–¥–æ —Å–¥–µ–ª–∞—Ç—å
                    <div class="count badge text-bg-warning count">0</div>
                </h5>
                <div id="new" data-id="new" class="task-list-dragdrop">
                    <div class="task" draggable="true">
                        <div class="task-header">
                            <div class="d-flex justify-content-between align-items-start gap-3">
                                <div class="task-title">
                                    –°–æ–∑–¥–∞—Ç—å –¥–∏–∑–∞–π–Ω –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                                </div>
                                <div class="card-menu">
                                    <button class="btn btn-icon" data-bs-toggle="dropdown">
                                        <ion-icon name="ellipsis-horizontal"></ion-icon>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#"><ion-icon name="eye-outline"></ion-icon>–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å</a></li>
                                        <li><a class="dropdown-item" href="#"><ion-icon name="trash-outline"></ion-icon>–£–¥–∞–ª–∏—Ç—å</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="task-body">
                            <div class="task-description">
                                –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏ —É–¥–æ–±–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ–µ–∫—Ç–∞.
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-secondary">15% –∏–∑ 100%</span>
                                <span class="text-secondary">18.01.2025</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" style="width: 15%"></div>
                            </div>
                        </div>
                        <div class="task-footer">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="task-platform-id">#UI001</div>
                                <div class="task-data d-flex align-items-center gap-3">
                                    <span class="d-flex align-items-center gap-1"><ion-icon name="eye-outline"></ion-icon> 4</span>
                                    <span class="d-flex align-items-center gap-1"><ion-icon name="chatbubbles-outline"></ion-icon> 15</span>
                                    <span class="d-flex align-items-center gap-1"><ion-icon name="document-attach-outline"></ion-icon> 2</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% if user.role_id in [1, 2, 3] %}
                <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                    <ion-icon name="add-outline"></ion-icon>
                    <span>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</span>
                </button>
                {% endif %}
            </div>

            <!-- –ö–æ–ª–æ–Ω–∫–∞ "–í —Ä–∞–±–æ—Ç–µ" -->
            <div class="task-list">
                <h5 class="task-list-head">
                    <ion-icon name="time-outline" style=""></ion-icon>
                    –í —Ä–∞–±–æ—Ç–µ
                    <div class="count badge text-bg-info">0</div>
                </h5>
                <div id="inprocess" data-id="inprocess" class="task-list-dragdrop"></div>
                {% if user.role_id in [1, 2, 3] %}
                <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                    <ion-icon name="add-outline"></ion-icon>
                    <span>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</span>
                </button>
                {% endif %}
            </div>

            <!-- –ö–æ–ª–æ–Ω–∫–∞ "–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ" -->
            <div class="task-list">
                <h5 class="task-list-head">
                    <ion-icon name="eye-outline" style="color: var(--primary-color)"></ion-icon>
                    –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ
                    <div class="count badge text-bg-primary">0</div>
                </h5>
                <div id="testing" data-id="testing" class="task-list-dragdrop"></div>
                {% if user.role_id in [1, 2, 3] %}
                <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                    <ion-icon name="add-outline"></ion-icon>
                    <span>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</span>
                </button>
                {% endif %}
            </div>

            <!-- –ö–æ–ª–æ–Ω–∫–∞ "–ì–æ—Ç–æ–≤–æ" -->
            <div class="task-list">
                <h5 class="task-list-head">
                    <ion-icon name="checkmark-circle-outline" style="color: var(--success-color)"></ion-icon>
                    –ì–æ—Ç–æ–≤–æ
                    <div class="count badge text-bg-success">0</div>
                </h5>
                <div id="done" data-id="done" class="task-list-dragdrop"></div>
                {% if user.role_id in [1, 2, 3] %}
                <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                    <ion-icon name="add-outline"></ion-icon>
                    <span>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</span>
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
    <div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTaskModalLabel">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addTaskForm">
                        <div class="mb-3">
                            <label for="taskTitle" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
                            <input type="text" class="form-control" id="taskTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="taskDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="taskPriority" class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                                <select class="form-select" id="taskPriority">
                                    <option value="low">–ù–∏–∑–∫–∏–π</option>
                                    <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
                                    <option value="high">–í—ã—Å–æ–∫–∏–π</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="taskDeadline" class="form-label">–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                                <input type="date" class="form-control" id="taskDeadline" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="taskPlatformId" class="form-label">ID –≤ —Å–∏—Å—Ç–µ–º–µ</label>
                            <input type="text" class="form-control" id="taskPlatformId" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" id="saveTaskBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}